# ADaM 分析数据模型完全指南：从零到精通

> 本教程面向想深入理解 ADaM 数据处理细节的读者，用通俗的语言和大量实例，带你彻底搞懂 ADaM 的方方面面。

---

## 目录

1. [为什么需要这篇教程？](#1-为什么需要这篇教程)
2. [ADaM 到底是什么？](#2-adam-到底是什么)
3. [ADaM 的三大类数据集](#3-adam-的三大类数据集)
4. [ADSL：受试者级别数据集详解](#4-adsl受试者级别数据集详解)
5. [BDS：基本数据结构详解](#5-bds基本数据结构详解)
6. [OCCDS：事件类数据结构详解](#6-occds事件类数据结构详解)
7. [核心派生变量全解析](#7-核心派生变量全解析)
8. [基线的确定：最关键的派生逻辑](#8-基线的确定最关键的派生逻辑)
9. [分析标志变量详解](#9-分析标志变量详解)
10. [时间变量的处理](#10-时间变量的处理)
11. [ADaM 数据集完整创建流程](#11-adam-数据集完整创建流程)
12. [真实案例：从 SDTM 到 ADVS 的完整派生](#12-真实案例从-sdtm-到-advs-的完整派生)
13. [常见错误与最佳实践](#13-常见错误与最佳实践)
14. [ADaM 合规性检查清单](#14-adam-合规性检查清单)
15. [总结与速查表](#15-总结与速查表)

---

## 1. 为什么需要这篇教程？

### 你可能遇到的困惑

如果你已经看过 ADaM 的基础介绍，可能还有这些疑问：

```
❓ 困惑 1：基线值到底怎么确定？
   "第一次检查是基线？还是治疗前最后一次是基线？"

❓ 困惑 2：AVAL 和原始值有什么区别？
   "不是直接把 SDTM 的值复制过来吗？"

❓ 困惑 3：那么多分析标志（ANL01FL、ANL02FL...），都是干什么的？
   "什么时候用哪个？"

❓ 困惑 4：ADSL 和其他数据集是怎么关联的？
   "为什么有些变量要从 ADSL 合并过来？"

❓ 困惑 5：ADaM 有哪些强制要求？
   "哪些是必须有的？哪些是可选的？"
```

### 本教程的目标

读完这篇教程，你将能够：

✅ 理解 ADaM 的设计理念和核心原则
✅ 掌握三大类 ADaM 数据集的结构和用途
✅ 学会计算所有核心派生变量
✅ 正确处理基线、变化值、分析标志
✅ 独立完成一个完整 ADaM 数据集的创建
✅ 避免常见的 ADaM 错误

---

## 2. ADaM 到底是什么？

### 一句话定义

**ADaM = Analysis Data Model = 分析数据模型**

> ADaM 是一套标准，规定了"统计分析用的数据"应该长什么样。

### SDTM vs ADaM：根本区别

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SDTM vs ADaM 本质区别                              │
└─────────────────────────────────────────────────────────────────────────┘

    SDTM                                    ADaM
    ──────                                  ──────

    目的：存储数据                           目的：分析数据

    问题："发生了什么？"                     问题："怎么分析？"

    类比：原材料仓库                         类比：生产线上的半成品
          （冷冻的肉、新鲜蔬菜）                  （切好的肉片、洗好的菜）

    特点：                                  特点：
    • 忠实记录原始数据                       • 添加派生变量
    • 一次检查一行                           • 添加分析标志
    • 不做任何计算                           • 支持直接统计分析
    • 变量名有固定前缀                       • 可追溯到 SDTM
```

### ADaM 的核心设计原则

ADaM 标准有四条核心原则，记住这四条，就能理解所有 ADaM 设计决策：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ADaM 四大核心原则                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1️⃣ 分析就绪（Analysis-Ready）                                         │
│      ─────────────────────────────                                      │
│      数据应该可以直接用于统计分析，不需要额外处理                           │
│                                                                         │
│      示例：如果要比较治疗前后的变化，ADaM 应该已经有：                      │
│            • 基线值（BASE）                                              │
│            • 变化值（CHG = AVAL - BASE）                                 │
│            而不是让统计程序再去计算                                        │
│                                                                         │
│   2️⃣ 可追溯（Traceability）                                              │
│      ─────────────────────────                                          │
│      每个 ADaM 变量都应该能追溯到 SDTM 或派生规则                          │
│                                                                         │
│      示例：ADVS.AVAL 可以追溯到 VS.VSSTRESN                              │
│            ADVS.CHG 可以追溯到公式 CHG = AVAL - BASE                     │
│                                                                         │
│   3️⃣ 一个观测一个目的（One Observation per Purpose）                     │
│      ─────────────────────────────────────────────                      │
│      每一行数据应该服务于一个明确的分析目的                                │
│                                                                         │
│      示例：如果同一时间点需要用于两种分析，可以有两行数据                   │
│            （用不同的 ANLxxFL 标志区分）                                   │
│                                                                         │
│   4️⃣ 清晰的元数据（Clear Metadata）                                      │
│      ─────────────────────────────                                      │
│      变量的含义、派生规则都应该在 Define.xml 中清楚说明                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ADaM 变量的三种来源

```
ADaM 变量从哪里来？
────────────────────

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   直接复制       │    │   简单转换       │    │   派生计算       │
│  from SDTM      │    │  from SDTM      │    │  Derived        │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│                 │    │                 │    │                 │
│ USUBJID         │    │ AVAL ← VSSTRESN │    │ CHG = AVAL-BASE │
│ STUDYID         │    │ ADT ← VSDTC     │    │ PCHG = CHG/BASE │
│ AGE             │    │ AVISIT ← VISIT  │    │ BASE (规则派生) │
│ SEX             │    │ PARAM ← VSTEST  │    │ ABLFL (标志)    │
│                 │    │                 │    │ ANL01FL (标志)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
      │                       │                       │
      └───────────────────────┼───────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   ADaM 数据集    │
                    └─────────────────┘
```

---

## 3. ADaM 的三大类数据集

ADaM 标准定义了三种数据集结构，每种结构适用于不同类型的分析：

### 三大类概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ADaM 三大数据集结构                                │
└─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │    ADSL     │  Subject Level（受试者级别）
    │  受试者级别  │  ─────────────────────────────
    └─────────────┘  • 每个受试者只有 1 行
                     • 汇总患者基本信息
                     • 是其他所有 ADaM 的"母表"

    ┌─────────────┐
    │    BDS      │  Basic Data Structure（基本数据结构）
    │  基本数据结构 │  ─────────────────────────────────
    └─────────────┘  • 每个受试者多行（一个指标一时间点一行）
                     • 用于连续型指标分析
                     • 例：ADVS、ADLB、ADEFF

    ┌─────────────┐
    │   OCCDS     │  Occurrence Data Structure（事件类数据结构）
    │  事件类数据  │  ──────────────────────────────────────
    └─────────────┘  • 每个事件一行
                     • 用于不良事件、合并用药等
                     • 例：ADAE、ADCM
```

### 三种结构的对比

| 特征 | ADSL | BDS | OCCDS |
|------|------|-----|-------|
| **每受试者行数** | 固定 1 行 | 多行（指标×时间点） | 多行（每事件一行） |
| **核心用途** | 人口学统计、分析集定义 | 疗效分析（血压、体重等） | 安全性分析（不良事件等） |
| **必须变量** | STUDYID, USUBJID, SITEID | STUDYID, USUBJID, PARAM, AVAL | STUDYID, USUBJID, AETERM |
| **典型数据集** | ADSL | ADVS, ADLB, ADEFF | ADAE, ADCM, ADMH |
| **是否有 PARAM** | ❌ 无 | ✅ 必须有 | ❌ 通常无 |
| **是否有 AVAL** | ❌ 无 | ✅ 必须有 | ❌ 通常无 |

### 数据集之间的关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       ADaM 数据集关系图                                   │
└─────────────────────────────────────────────────────────────────────────┘

                            SDTM 数据
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
    ┌──────┐              ┌──────┐              ┌──────┐
    │  DM  │              │  VS  │              │  AE  │  ...
    └──┬───┘              └──┬───┘              └──┬───┘
        │                      │                      │
        │                      │                      │
        ▼                      │                      │
    ╔════════════════════╗     │                      │
    ║       ADSL         ║     │                      │
    ║  (一人一行，核心表) ║     │                      │
    ╚════════════════════╝     │                      │
        │                      │                      │
        │  ┌───────────────────┤                      │
        │  │                   │                      │
        │  │ 合并 ADSL 信息    │                      │
        │  │                   │                      │
        ▼  ▼                   ▼                      ▼
    ┌──────────┐         ┌──────────┐         ┌──────────┐
    │  ADEFF   │         │   ADVS   │         │   ADAE   │
    │ 疗效数据  │         │ 生命体征  │         │ 不良事件  │
    │  (BDS)   │         │  (BDS)   │         │ (OCCDS)  │
    └──────────┘         └──────────┘         └──────────┘

    关系说明：
    • ADSL 是"核心表"，其他 ADaM 数据集都要从 ADSL 合并信息
    • ADSL 提供：治疗组(TRT01P)、分析集标志(SAFFL, ITTFL)等
    • 通过 USUBJID 关联
```

---

## 4. ADSL：受试者级别数据集详解

### ADSL 是什么？

ADSL（Subject-Level Analysis Dataset）是 ADaM 中最重要的数据集，也是唯一一个**必须**创建的数据集。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ADSL 特点                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   📌 唯一强制要求的 ADaM 数据集                                           │
│                                                                         │
│   📌 每个受试者只有一行（所有信息压缩在一行里）                            │
│                                                                         │
│   📌 是其他 ADaM 数据集的"源头"——提供患者信息供合并                       │
│                                                                         │
│   📌 包含人口学信息、治疗分配、分析集标志等                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ADSL 必须包含的变量

```
ADSL 必须变量（Identifier Variables）
─────────────────────────────────────

变量名         类型      说明
──────────────────────────────────────────────────
STUDYID       Char      研究标识符
USUBJID       Char      唯一受试者标识符
SUBJID        Char      受试者标识符
SITEID        Char      研究中心标识符
```

### ADSL 核心变量详解

#### 人口学变量

```
人口学变量（从 DM 域获取或派生）
─────────────────────────────────

变量名      来源          说明                  示例值
────────────────────────────────────────────────────────
AGE        DM.AGE        年龄                  58
AGEU       DM.AGEU       年龄单位              YEARS
SEX        DM.SEX        性别                  M / F
RACE       DM.RACE       人种                  WHITE / ASIAN
ETHNIC     DM.ETHNIC     民族                  HISPANIC / NOT HISPANIC
COUNTRY    DM.COUNTRY    国家                  CHN / USA

派生变量：
AGEGR1     派生          年龄分组（自定义）     <50 / 50-64 / ≥65
AGEGR1N    派生          年龄分组（数字编码）   1 / 2 / 3
RACEN      派生          人种（数字编码）       1 / 2 / 3
```

**年龄分组派生示例：**

```
AGEGR1 派生逻辑
─────────────────

if AGE < 50 then AGEGR1 = "<50";
else if AGE < 65 then AGEGR1 = "50-64";
else AGEGR1 = "≥65";

对应数字编码：
if AGE < 50 then AGEGR1N = 1;
else if AGE < 65 then AGEGR1N = 2;
else AGEGR1N = 3;
```

#### 治疗变量

```
治疗变量（Treatment Variables）
─────────────────────────────────

变量名        说明                        示例值
────────────────────────────────────────────────────
TRT01P       计划治疗（Period 1）         Drug A 10mg / Placebo
TRT01PN      计划治疗（数字编码）          1 / 2
TRT01A       实际治疗（Period 1）         Drug A 10mg / Placebo
TRT01AN      实际治疗（数字编码）          1 / 2
TRTSDT       治疗开始日期                  2024-01-15
TRTEDT       治疗结束日期                  2024-02-15
TRTDURD      治疗持续天数                  32

多周期试验还会有：
TRT02P, TRT02PN, TRT02A, TRT02AN  （第2期治疗）
...
```

**为什么有"计划"和"实际"两套变量？**

```
计划治疗 vs 实际治疗
─────────────────────

场景：患者随机分配到 Drug A 组，但因为不良反应，
      中途换成了 Placebo

                    随机化           实际情况
                       │                │
                       ▼                ▼
TRT01P = "Drug A"   计划给药          实际给药   TRT01A = "Drug A"
                    Drug A            然后换成    → 或者
                       │             Placebo     TRT01A = "Placebo"
                       │                │        （看分析目的）
                       │                │
                       ▼                ▼
                  ITT 分析         PP/Safety 分析
               （按计划分组）       （按实际分组）
```

#### 分析集标志变量

```
分析集标志变量（Population Flags）
───────────────────────────────────

变量名        说明                    值         定义
──────────────────────────────────────────────────────────────────
ITTFL        意向治疗分析集标志        Y/N       所有随机化的受试者
SAFFL        安全性分析集标志          Y/N       至少接受过一次研究药物
PPROTFL      符合方案分析集标志        Y/N       完成试验且无重大方案违背
FASFL        全分析集标志              Y/N       随机化+至少一次基线后数据
COMPLFL     完成研究标志              Y/N       完成所有计划访视
```

**分析集关系图：**

```
                    签署知情同意
                         │
                         ▼
                    ┌─────────┐
                    │ 筛选入组 │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
               ┌────│ 随机化  │────┐
               │    └─────────┘    │
               │                   │
               │                   │
               ▼                   ▼
          ┌─────────┐        ┌─────────┐
          │ ITTFL=Y │        │ ITTFL=N │  未随机化
          │所有随机化│        │(筛选失败)│
          └────┬────┘        └─────────┘
               │
        ┌──────┴───────┐
        │              │
        ▼              ▼
   ┌─────────┐   ┌─────────┐
   │ SAFFL=Y │   │ SAFFL=N │  从未用药
   │至少用药1次│   │         │
   └────┬────┘   └─────────┘
        │
        ├──────────────────┐
        │                  │
        ▼                  ▼
   ┌─────────┐       ┌─────────┐
   │PPROTFL=Y│       │PPROTFL=N│
   │按方案完成│       │方案违背/退出│
   └─────────┘       └─────────┘
```

#### 时间相关变量

```
关键日期变量
─────────────────

变量名         说明                    来源/派生
──────────────────────────────────────────────────────────
RFSTDTC       参考开始日期时间         从 DM.RFSTDTC
RFENDTC       参考结束日期时间         从 DM.RFENDTC
TRTSDT        治疗开始日期             从 EX 域派生（首次给药日期）
TRTEDT        治疗结束日期             从 EX 域派生（末次给药日期）
RANDDT        随机化日期               从随机化记录
DTHDT         死亡日期                 从 DM.DTHDTC 或 DS 域

派生变量：
TRTDURD       治疗持续天数             TRTEDT - TRTSDT + 1
STUDYDY       研究天数                 访视日期 - RFSTDTC + 1
```

### ADSL 完整示例

```
ADSL 示例数据（横向展示主要变量）
──────────────────────────────────────────────────────────────────────────

USUBJID        AGE  SEX  AGEGR1   TRT01P      TRTSDT      SAFFL  ITTFL
──────────────────────────────────────────────────────────────────────────
STUDY001-001   58   M    50-64    Drug A      2024-01-15  Y      Y
STUDY001-002   62   F    50-64    Placebo     2024-01-16  Y      Y
STUDY001-003   45   M    <50      Drug A      2024-01-17  Y      Y
STUDY001-004   71   F    ≥65      Placebo     2024-01-18  Y      Y
STUDY001-005   55   M    50-64    Drug A      .           N      Y

说明：
• 005 号患者随机化了（ITTFL=Y），但从未用药（SAFFL=N），TRTSDT 为空
• 每个患者只有一行
• 所有分类变量都有对应的数字编码（未显示）
```

---

## 5. BDS：基本数据结构详解

### BDS 是什么？

BDS（Basic Data Structure）是用于分析**连续型指标**的数据结构。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           BDS 特点                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   📌 每个受试者有多行（一个参数 × 一个时间点 = 一行）                      │
│                                                                         │
│   📌 必须有 PARAM 和 AVAL 变量                                           │
│                                                                         │
│   📌 支持派生变量：BASE、CHG、PCHG 等                                     │
│                                                                         │
│   📌 常见数据集：ADVS、ADLB、ADEFF、ADEG 等                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### BDS 核心变量

```
BDS 必须变量
─────────────────

变量名        类型      说明                            示例值
────────────────────────────────────────────────────────────────────
STUDYID      Char      研究标识符                       STUDY001
USUBJID      Char      唯一受试者标识符                 STUDY001-001
PARAM        Char      参数描述                         Systolic BP (mmHg)
PARAMCD      Char      参数代码                         SYSBP
AVAL         Num       分析值                           145
AVALC        Char      分析值（字符型，当需要时）       HIGH / NORMAL
```

```
BDS 常用派生变量
─────────────────

变量名        类型      说明                            派生方法
────────────────────────────────────────────────────────────────────
BASE         Num       基线值                          基线期的 AVAL
BASEC        Char      基线值（字符型）                基线期的 AVALC
CHG          Num       变化值                          CHG = AVAL - BASE
PCHG         Num       变化百分比                      PCHG = (CHG/BASE)*100
ABLFL        Char      基线记录标志                    Y = 这行是基线
ANL01FL      Char      分析标志 01                     Y = 纳入主要分析
AVISIT       Char      分析访视                        Baseline / Week 4
AVISITN      Num       分析访视（数字）                0 / 4
ADT          Num       分析日期                        SAS 日期格式
ADY          Num       分析天数                        ADT - TRTSDT + 1
```

### PARAM 和 PARAMCD 详解

```
PARAM vs PARAMCD
─────────────────

PARAMCD：短代码，用于程序处理
PARAM：完整描述，用于报告显示

┌──────────────────────────────────────────────────────────────────┐
│  PARAMCD        PARAM                         用途              │
├──────────────────────────────────────────────────────────────────┤
│  SYSBP          Systolic Blood Pressure (mmHg)   收缩压          │
│  DIABP          Diastolic Blood Pressure (mmHg)  舒张压          │
│  HR             Heart Rate (beats/min)            心率           │
│  TEMP           Temperature (C)                   体温           │
│  WEIGHT         Weight (kg)                       体重           │
│  HEIGHT         Height (cm)                       身高           │
│  BMI            Body Mass Index (kg/m²)           体重指数       │
│  GLUC           Glucose (mmol/L)                  血糖           │
│  ALT            ALT (U/L)                         谷丙转氨酶     │
│  AST            AST (U/L)                         谷草转氨酶     │
└──────────────────────────────────────────────────────────────────┘

注意：
• PARAM 应包含单位
• PARAMCD 最多 8 个字符
• 同一指标在不同数据集中应使用相同的 PARAMCD
```

### BDS 数据结构示例

```
ADVS 示例数据（一个患者的收缩压数据）
──────────────────────────────────────────────────────────────────────────

USUBJID        PARAMCD  PARAM                    AVISIT      AVAL  BASE  CHG
──────────────────────────────────────────────────────────────────────────
STUDY001-001   SYSBP    Systolic BP (mmHg)       Screening   155   .     .
STUDY001-001   SYSBP    Systolic BP (mmHg)       Baseline    152   152   0
STUDY001-001   SYSBP    Systolic BP (mmHg)       Week 1      148   152   -4
STUDY001-001   SYSBP    Systolic BP (mmHg)       Week 2      145   152   -7
STUDY001-001   SYSBP    Systolic BP (mmHg)       Week 4      138   152   -14

──────────────────────────────────────────────────────────────────────────
（续）
ABLFL    ANL01FL    ADT          ADY     TRT01P
──────────────────────────────────────────────────────────────────────────
.        .          2024-01-08   -7      Drug A     ← 筛选期，治疗前
Y        Y          2024-01-15   1       Drug A     ← 基线，ABLFL=Y
.        Y          2024-01-22   8       Drug A
.        Y          2024-01-29   15      Drug A
.        Y          2024-02-12   29      Drug A     ← 主要分析时点

说明：
• 同一患者同一指标有多行（每个时间点一行）
• 基线行的 ABLFL = Y
• BASE 值传播到所有行（都是 152）
• CHG 只有非基线行才有值
• 筛选期数据通常不纳入分析（ANL01FL 为空）
```

---

## 6. OCCDS：事件类数据结构详解

### OCCDS 是什么？

OCCDS（Occurrence Data Structure）用于分析**事件类数据**，如不良事件、合并用药等。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          OCCDS 特点                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   📌 每个事件一行（而不是每个时间点）                                      │
│                                                                         │
│   📌 没有 PARAM/AVAL（不是连续型数据）                                    │
│                                                                         │
│   📌 有事件特定的变量（如 AEDECOD、AEBODSYS）                             │
│                                                                         │
│   📌 常见数据集：ADAE、ADCM、ADMH                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ADAE 核心变量

```
ADAE 核心变量
─────────────────

变量名         类型      来源           说明
────────────────────────────────────────────────────────────────────
USUBJID       Char      AE.USUBJID     唯一受试者标识符
AETERM        Char      AE.AETERM      不良事件原始术语
AEDECOD       Char      AE.AEDECOD     不良事件标准术语（MedDRA PT）
AEBODSYS      Char      AE.AEBODSYS    系统器官分类（MedDRA SOC）
AESEV         Char      AE.AESEV       严重程度（MILD/MODERATE/SEVERE）
AESER         Char      AE.AESER       是否严重（Y/N）
AEREL         Char      AE.AEREL       与研究药物的关系
AEOUT         Char      AE.AEOUT       转归
ASTDT         Num       派生           不良事件开始日期
AENDT         Num       派生           不良事件结束日期
AESTDY        Num       派生           开始研究日（相对于 TRTSDT）
AEENDY        Num       派生           结束研究日

派生标志变量：
TRTEMFL       Char      派生           治疗期不良事件标志
PREFL         Char      派生           治疗前不良事件标志
AEOCCFL       Char      派生           首次发生标志（用于按事件计数）
AOCCPFL       Char      派生           首次发生标志（用于按患者计数）
```

### ADAE 数据结构示例

```
ADAE 示例数据
──────────────────────────────────────────────────────────────────────────

USUBJID        AETERM         AEDECOD      AEBODSYS              AESEV
──────────────────────────────────────────────────────────────────────────
STUDY001-001   头痛           Headache     神经系统疾病           MILD
STUDY001-001   恶心           Nausea       胃肠系统疾病           MILD
STUDY001-001   头晕           Dizziness    神经系统疾病           MODERATE
STUDY001-002   腹泻           Diarrhoea    胃肠系统疾病           MILD
STUDY001-003   皮疹           Rash         皮肤及皮下组织疾病     SEVERE

──────────────────────────────────────────────────────────────────────────
（续）
ASTDT        AENDT        TRTEMFL   TRT01A      SAFFL
──────────────────────────────────────────────────────────────────────────
2024-01-18   2024-01-20   Y         Drug A      Y
2024-01-22   2024-01-25   Y         Drug A      Y
2024-02-01   .            Y         Drug A      Y       ← 未结束
2024-01-20   2024-01-22   Y         Placebo     Y
2024-01-25   2024-02-10   Y         Drug A      Y

说明：
• 每个不良事件一行
• TRTEMFL = Y 表示是治疗期出现的不良事件
• 003 号患者的皮疹比较严重（SEVERE）
• 001 号患者的头晕还没结束（AENDT 为空）
```

### 治疗期不良事件的判断

```
TRTEMFL（治疗期不良事件标志）派生逻辑
─────────────────────────────────────────

                    治疗开始日          治疗结束日
                    TRTSDT              TRTEDT
                       │                   │
    ───────────────────┼───────────────────┼───────────────────▶ 时间
                       │                   │
    ┌──────────────────│                   │
    │  治疗前          │    治疗期间        │    治疗后
    │  TRTEMFL = N     │   TRTEMFL = Y     │   TRTEMFL = ?
    └──────────────────│                   │
                       │                   │

规则（常见定义）：
─────────────────
TRTEMFL = Y，当满足以下任一条件：
  1. 不良事件开始于治疗期间：ASTDT >= TRTSDT
  2. 或者：不良事件开始于治疗前，但在治疗期间加重

注意：不同试验可能有不同的定义，需要看 SAP
```

---

## 7. 核心派生变量全解析

### 派生变量总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       ADaM 核心派生变量                                   │
└─────────────────────────────────────────────────────────────────────────┘

    类型                变量            说明
    ────────────────────────────────────────────────────────────────

    分析值相关          AVAL            分析值（数值）
                       AVALC           分析值（字符）
                       BASE            基线值
                       CHG             变化值（AVAL - BASE）
                       PCHG            变化百分比（CHG/BASE × 100）

    标志变量           ABLFL           基线记录标志
                       ANL01FL         分析标志 01
                       ANL02FL         分析标志 02

    时间变量           ADT             分析日期
                       ATM             分析时间
                       ADY             分析研究日
                       AVISIT          分析访视
                       AVISITN         分析访视（数字）

    分类变量           ACAT1           分析分类 1
                       SHIFT1          基线后相对基线的移位
                       CRIT1           分析标准 1
                       CRIT1FL         满足标准 1 的标志
```

### AVAL：分析值

```
AVAL 的来源和处理
─────────────────

场景 1：直接复制（最常见）
─────────────────────────
AVAL = VSSTRESN（标准化数值结果）

场景 2：单位转换
─────────────────────────
SDTM 记录：体温 = 98.6 °F
ADaM 需要：体温 = 37.0 °C

AVAL = (VSSTRESN - 32) × 5/9

场景 3：派生指标
─────────────────────────
BMI（体重指数）不是直接测量的，需要计算：

AVAL = WEIGHT / (HEIGHT/100)²

场景 4：取平均值
─────────────────────────
如果同一时间点有多次测量（如坐 5 分钟测 3 次血压），
需要取平均值：

AVAL = mean(VSSTRESN) where VSTPT = "AFTER 5 MIN"
```

### CHG 和 PCHG：变化值

```
CHG 和 PCHG 计算公式
─────────────────────

CHG  = AVAL - BASE       （绝对变化）
PCHG = (CHG / BASE) × 100   （百分比变化）

┌─────────────────────────────────────────────────────────────────┐
│ 示例：                                                          │
│                                                                 │
│ 基线血压 = 160 mmHg                                             │
│ 第4周血压 = 140 mmHg                                            │
│                                                                 │
│ CHG  = 140 - 160 = -20 mmHg （降低了 20）                       │
│ PCHG = (-20 / 160) × 100 = -12.5% （降低了 12.5%）              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

特殊情况处理：
─────────────────
• 如果 BASE = 0，PCHG 应该是缺失值（不能除以零）
• 如果 BASE 或 AVAL 缺失，CHG 和 PCHG 也缺失
• 基线行本身的 CHG 通常设为 0 或缺失（看公司惯例）
```

### 派生计算的伪代码示例

```
派生 CHG 和 PCHG 的逻辑
─────────────────────────

/* 步骤 1：首先确定基线 */
if ABLFL = 'Y' then BASE = AVAL;

/* 步骤 2：把 BASE 传播到所有记录 */
proc sort data=advs;
  by USUBJID PARAMCD;
run;

data advs;
  set advs;
  by USUBJID PARAMCD;
  retain _BASE_;
  if first.PARAMCD then _BASE_ = .;
  if ABLFL = 'Y' then _BASE_ = AVAL;
  BASE = _BASE_;
run;

/* 步骤 3：计算 CHG 和 PCHG */
data advs;
  set advs;
  if ABLFL ^= 'Y' and BASE ^= . and AVAL ^= . then do;
    CHG = AVAL - BASE;
    if BASE ^= 0 then PCHG = (CHG / BASE) * 100;
  end;
run;
```

---

## 8. 基线的确定：最关键的派生逻辑

### 为什么基线如此重要？

```
基线的重要性
─────────────────

基线（Baseline）是评价疗效的"比较基准"。

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  没有基线，就无法回答最关键的问题：                                       │
│                                                                         │
│  "这个药到底让患者改善了多少？"                                           │
│                                                                         │
│  患者 A：第 4 周血压 = 135 mmHg                                          │
│                                                                         │
│  好还是不好？不知道！                                                     │
│                                                                         │
│  如果基线是 135 → 没变化 → 无效                                          │
│  如果基线是 160 → 降了 25 → 很有效！                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 基线定义的常见规则

```
基线确定规则（按优先级排序，常见定义）
─────────────────────────────────────────

规则 1：治疗开始前最后一次非缺失检查
──────────────────────────────────────
这是最常用的定义。

        筛选访视        基线访视        首次给药        第1周
           │              │               │              │
    ───────┴──────────────┴───────────────┴──────────────┴─────▶ 时间
           │              │               │
      血压 155        血压 152        开始治疗
                          ↑
                     这是基线！
                     （治疗前最后一次）


规则 2：特定访视的检查值
──────────────────────────────────────
有些试验明确规定"第 0 天访视"为基线。

        筛选访视        Day 0          首次给药        第1周
           │              │               │              │
    ───────┴──────────────┴───────────────┴──────────────┴─────▶ 时间
           │              │
      血压 155        血压 152
                          ↑
                     这是基线！
                     （Day 0 定义为基线访视）


规则 3：多次测量取平均/最差值
──────────────────────────────────────
有些指标需要多次测量确认。

        筛选访视                    首次给药
           │                          │
    ───────┴──────────────────────────┴─────────▶ 时间
           │
      血压测量 1: 155
      血压测量 2: 150
      血压测量 3: 153
      ────────────
      基线 = 平均值 = 152.7（约 153）
```

### 基线派生的详细逻辑

```
基线派生完整流程
─────────────────

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   输入：SDTM VS 数据                                                     │
│                                                                         │
│   USUBJID        VSDTC         VSTESTCD    VSSTRESN    VISIT           │
│   ──────────────────────────────────────────────────────────────────    │
│   001            2024-01-08    SYSBP       155         SCREENING        │
│   001            2024-01-14    SYSBP       153         BASELINE         │
│   001            2024-01-15    SYSBP       152         DAY 1            │
│   001            2024-01-22    SYSBP       148         WEEK 1           │
│                                                                         │
│   假设：首次给药日期 TRTSDT = 2024-01-15                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   步骤 1：识别治疗前的记录                                               │
│                                                                         │
│   USUBJID    ADT           AVAL    TRTSDT        ADT < TRTSDT?         │
│   ──────────────────────────────────────────────────────────────────    │
│   001        2024-01-08    155     2024-01-15    Y ← 治疗前             │
│   001        2024-01-14    153     2024-01-15    Y ← 治疗前             │
│   001        2024-01-15    152     2024-01-15    N ← 治疗当天           │
│   001        2024-01-22    148     2024-01-15    N ← 治疗后             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   步骤 2：找到治疗前最后一次                                             │
│                                                                         │
│   治疗前记录中：                                                         │
│   2024-01-08: 155                                                        │
│   2024-01-14: 153 ← 这是最后一次！                                       │
│                                                                         │
│   所以：ABLFL = 'Y' 标记在 2024-01-14 这条记录                           │
│         BASE = 153                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   输出：ADaM ADVS 数据                                                   │
│                                                                         │
│   USUBJID   AVISIT      AVAL   BASE   CHG   ABLFL   ANL01FL            │
│   ──────────────────────────────────────────────────────────────────    │
│   001       Screening   155    153    .     .       .        治疗前数据│
│   001       Baseline    153    153    0     Y       Y        ← 基线    │
│   001       Day 1       152    153    -1    .       .        给药当天  │
│   001       Week 1      148    153    -5    .       Y        ← 分析用  │
│                                                                         │
│   注意：                                                                 │
│   • BASE = 153 传播到所有行                                              │
│   • 只有 ABLFL = Y 的行才是基线                                          │
│   • CHG = AVAL - BASE                                                   │
│   • ANL01FL = Y 表示纳入主要分析（通常是基线和治疗后访视）                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 基线定义的常见问题

```
FAQ：基线相关问题
─────────────────

Q1：如果治疗当天也有检查，算基线吗？
───────────────────────────────────
取决于 SAP 定义：
• 严格定义：只有治疗前（ADT < TRTSDT）才算
• 宽松定义：治疗当天给药前（ADT <= TRTSDT）也算

Q2：如果筛选期有多次检查，用哪个？
───────────────────────────────────
通常用"治疗前最后一次"，但也可能：
• 用特定访视（如"基线访视"）
• 用多次测量的平均值
• 需要看 SAP 规定

Q3：如果基线缺失怎么办？
───────────────────────────────────
• CHG 和 PCHG 也会缺失
• 该受试者可能被排除出某些分析
• 可能需要用缺失数据处理方法（如插补）

Q4：不同指标可以有不同的基线定义吗？
───────────────────────────────────
可以！比如：
• 疗效指标：用治疗前最后一次
• 安全性实验室指标：用治疗前最高/最低值

Q5：基线后检查缺失，但基线存在，CHG 是多少？
───────────────────────────────────
CHG = 缺失（因为 AVAL 缺失，无法计算）
```

---

## 9. 分析标志变量详解

### 什么是分析标志？

```
分析标志的作用
─────────────────

问题：一个数据集里有很多行，但不是所有行都用于分析

ADVS 数据示例：
──────────────────────────────────────
USUBJID    AVISIT       AVAL    用于分析？
──────────────────────────────────────
001        Screening    155     ❌ 不用（筛选期）
001        Baseline     152     ✅ 用于分析
001        Week 1       148     ✅ 用于分析
001        Week 2       145     ❌ 不用（中间访视）
001        Week 4       138     ✅ 用于分析（主要时点）
001        Early Term   140     ❌ 不用（提前退出）

怎么标记哪些行用于分析？
─────────────────────────
用分析标志变量！

ANL01FL = 'Y' 表示这行用于主要分析
ANL01FL = 空  表示这行不用于主要分析
```

### 常用分析标志变量

```
分析标志变量命名规则
─────────────────────

格式：ANLxxFL
      │││ │
      │││ └── FL = Flag（标志）
      │││
      │└┴──── xx = 序号（01, 02, 03...）
      │
      └────── ANL = Analysis（分析）

常见用途：
──────────────────────────────────────────────────────
变量名      用途                    典型取值条件
──────────────────────────────────────────────────────
ANL01FL    主要疗效分析              基线 + 主要时点（如 Week 4）
ANL02FL    所有计划访视              基线 + 所有计划的治疗后访视
ANL03FL    LOCF 分析                末次非缺失观测
ANL04FL    安全性分析               治疗期内的记录
ANL05FL    特定亚组分析             满足特定条件的记录
```

### ABLFL：基线标志

```
ABLFL 详解
─────────────────

ABLFL = Baseline Flag = 基线记录标志

取值：
• ABLFL = 'Y'  → 这行是基线记录
• ABLFL = ''   → 这行不是基线（空值，不是 'N'）

特点：
• 每个受试者每个参数只有一行 ABLFL = 'Y'
• ABLFL 和 BASE 的关系：ABLFL = 'Y' 那行的 AVAL 就是 BASE 值

示例：
──────────────────────────────────────────────────────
USUBJID   PARAMCD   AVISIT      AVAL   BASE   ABLFL
──────────────────────────────────────────────────────
001       SYSBP     Baseline    152    152    Y      ← 基线
001       SYSBP     Week 1      148    152
001       SYSBP     Week 4      138    152
001       DIABP     Baseline    95     95     Y      ← 另一个参数的基线
001       DIABP     Week 1      92     95
001       DIABP     Week 4      88     95
```

### 派生 ANL01FL 的逻辑

```
ANL01FL 派生示例（主要分析标志）
───────────────────────────────────

假设 SAP 规定：
"主要分析纳入基线和第 4 周的数据"

派生规则：
──────────────────────────────────────────────────
if AVISIT in ('Baseline', 'Week 4')
   and AVAL is not missing
   and PARAMCD in ('SYSBP', 'DIABP')
then ANL01FL = 'Y';
else ANL01FL = '';

结果：
──────────────────────────────────────────────────────
USUBJID   PARAMCD   AVISIT      AVAL   ANL01FL   说明
──────────────────────────────────────────────────────
001       SYSBP     Screening   155              筛选期不纳入
001       SYSBP     Baseline    152    Y         ← 纳入
001       SYSBP     Week 1      148              Week 1 不是主要时点
001       SYSBP     Week 2      145              Week 2 不是主要时点
001       SYSBP     Week 4      138    Y         ← 纳入
001       SYSBP     Week 4      .                Week 4 但缺失，不纳入
```

### 多个分析标志的组合使用

```
多个分析标志示例
───────────────────────────────────

场景：
• ANL01FL：主要分析（基线 + Week 4）
• ANL02FL：辅助分析（所有计划访视）
• ANL03FL：LOCF 分析（每受试者每参数最后一次非缺失）

数据示例：
──────────────────────────────────────────────────────────────
USUBJID  PARAMCD  AVISIT     AVAL   ANL01FL  ANL02FL  ANL03FL
──────────────────────────────────────────────────────────────
001      SYSBP    Baseline   152    Y        Y
001      SYSBP    Week 1     148             Y
001      SYSBP    Week 2     145             Y
001      SYSBP    Week 4     138    Y        Y        Y      ← LOCF
002      SYSBP    Baseline   165    Y        Y
002      SYSBP    Week 1     158             Y
002      SYSBP    Week 2     .                                ← 缺失
002      SYSBP    Week 4     .                                ← 缺失
002      SYSBP    Week 1     158             .        Y      ← LOCF（最后非缺失）

说明：
• 002 号患者 Week 2 和 Week 4 缺失
• 002 的 LOCF 用 Week 1 的值（最后一次非缺失）
• 主要分析只纳入 Week 4，所以 002 不纳入主要分析
```

---

## 10. 时间变量的处理

### 关键时间变量

```
ADaM 时间变量体系
─────────────────

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   绝对时间变量                                                           │
│   ────────────                                                          │
│   ADT      分析日期（SAS 日期格式）                                       │
│   ATM      分析时间（SAS 时间格式）                                       │
│   ADTM     分析日期时间（SAS 日期时间格式）                               │
│                                                                         │
│   相对时间变量                                                           │
│   ────────────                                                          │
│   ADY      分析研究日（相对于 TRTSDT）                                    │
│   AENDY    分析结束研究日                                                │
│                                                                         │
│   访视相关变量                                                           │
│   ────────────                                                          │
│   AVISIT   分析访视（字符）                                              │
│   AVISITN  分析访视（数字）                                              │
│   ATPT     分析时间点（字符，如 "Pre-dose", "1h Post-dose"）             │
│   ATPTN    分析时间点（数字）                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### ADY 的计算

```
ADY（分析研究日）计算规则
───────────────────────────

公式：
• 如果 ADT >= TRTSDT：ADY = ADT - TRTSDT + 1
• 如果 ADT < TRTSDT： ADY = ADT - TRTSDT

为什么有 +1？
────────────────────────────────────────

因为治疗开始当天是"第 1 天"，不是"第 0 天"

时间线：
        TRTSDT          TRTSDT+1        TRTSDT+2
           │               │               │
    ───────┴───────────────┴───────────────┴──────▶
           │               │               │
         Day 1           Day 2           Day 3
      (ADY = 1)       (ADY = 2)       (ADY = 3)

治疗前呢？
────────────────────────────────────────

        TRTSDT-2        TRTSDT-1        TRTSDT
           │               │               │
    ───────┴───────────────┴───────────────┴──────▶
           │               │               │
        Day -2          Day -1          Day 1
      (ADY = -2)      (ADY = -1)      (ADY = 1)

注意：没有 Day 0！
```

### AVISIT 和 AVISITN 的设计

```
AVISIT 设计原则
───────────────────────────────────

1. AVISIT 应该是"分析友好"的访视名称
   • 不一定和 SDTM 的 VISIT 完全相同
   • 可以合并某些访视
   • 可以创建"窗口期"访视

2. AVISITN 用于排序
   • 数字越小表示越早
   • 便于程序按时间顺序处理

示例：
──────────────────────────────────────────────────────
SDTM VISIT        →  ADaM AVISIT       AVISITN
──────────────────────────────────────────────────────
SCREENING            Screening         -1
BASELINE             Baseline          0
WEEK 1               Week 1            1
WEEK 2               Week 2            2
WEEK 4               Week 4            4
WEEK 8               Week 8            8
END OF STUDY         End of Study      99
EARLY TERMINATION    Early Term        99
UNSCHEDULED          Unscheduled       .

说明：
• AVISITN 不必连续（如 1, 2, 4, 8）
• 特殊访视可以用大数字（如 99）
• 非计划访视 AVISITN 可以为缺失
```

### 访视窗口的处理

```
访视窗口（Visit Window）概念
───────────────────────────────────

问题：SAP 规定"第 4 周"测量，但实际检查日期可能是：
      • 第 25 天（早了 3 天）
      • 第 28 天（正好）
      • 第 31 天（晚了 3 天）

这些都应该归到 "Week 4" 吗？

访视窗口定义示例：
──────────────────────────────────────────────────────
计划访视      目标天数      窗口范围
──────────────────────────────────────────────────────
Baseline      Day 1         Day -7 to Day 1
Week 1        Day 8         Day 5 to Day 11
Week 2        Day 15        Day 12 to Day 18
Week 4        Day 29        Day 22 to Day 36
Week 8        Day 57        Day 50 to Day 64

派生规则：
──────────────────────────────────────────────────────
if -7 <= ADY <= 1 then AVISIT = 'Baseline';
else if 5 <= ADY <= 11 then AVISIT = 'Week 1';
else if 12 <= ADY <= 18 then AVISIT = 'Week 2';
else if 22 <= ADY <= 36 then AVISIT = 'Week 4';
else if 50 <= ADY <= 64 then AVISIT = 'Week 8';
else AVISIT = 'Unscheduled';
```

---

## 11. ADaM 数据集完整创建流程

### 创建流程概览

```
ADaM 数据集创建完整流程
───────────────────────────────────────────────────────────────────────

    ┌─────────────┐
    │  阅读 SAP   │  了解分析需求、终点定义、分析人群
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ 创建 ADSL   │  必须第一个创建！其他数据集依赖它
    └──────┬──────┘
           │
           │  ┌──────────────────────────────────────────┐
           │  │  ADSL 创建步骤：                          │
           │  │  1. 从 DM 获取人口学变量                  │
           │  │  2. 从 EX 计算治疗日期                    │
           │  │  3. 派生年龄分组等分类变量                │
           │  │  4. 派生分析集标志（ITTFL, SAFFL...）     │
           │  │  5. 从其他域获取额外信息                  │
           │  └──────────────────────────────────────────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────┐
    │                  创建其他 ADaM 数据集                │
    │                                                     │
    │   ┌─────────┐   ┌─────────┐   ┌─────────┐          │
    │   │  ADVS   │   │  ADLB   │   │  ADAE   │ ...      │
    │   └─────────┘   └─────────┘   └─────────┘          │
    │                                                     │
    └─────────────────────────────────────────────────────┘
           │
           │  每个数据集的创建步骤：
           │  ┌──────────────────────────────────────────┐
           │  │  1. 从对应 SDTM 域获取源数据              │
           │  │  2. 合并 ADSL 中的受试者信息              │
           │  │  3. 派生分析值（AVAL）                    │
           │  │  4. 确定基线（ABLFL, BASE）               │
           │  │  5. 计算变化值（CHG, PCHG）               │
           │  │  6. 设置分析标志（ANL01FL...）            │
           │  │  7. 添加其他需要的变量                    │
           │  └──────────────────────────────────────────┘
           │
           ▼
    ┌─────────────┐
    │   QC 验证    │  检查派生逻辑、数据一致性
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │  生成文档   │  更新 Define.xml、ADRG
    └─────────────┘
```

### ADSL 创建详细步骤

```
ADSL 创建详细步骤
───────────────────────────────────

步骤 1：准备源数据
────────────────────────────────────────
• DM：人口学信息
• EX：用药信息（治疗日期）
• DS：受试者状态（完成/退出）
• 随机化表：治疗分配

步骤 2：从 DM 获取基本变量
────────────────────────────────────────
data adsl_step1;
  set sdtm.dm;
  keep STUDYID USUBJID SUBJID SITEID
       AGE AGEU SEX RACE ETHNIC COUNTRY
       RFSTDTC RFENDTC;
run;

步骤 3：从 EX 派生治疗日期
────────────────────────────────────────
/* 首次给药日期 */
proc sql;
  create table ex_first as
  select USUBJID,
         min(EXSTDTC) as TRTSDT format=date9.
  from sdtm.ex
  where EXDOSE > 0
  group by USUBJID;
quit;

/* 末次给药日期 */
proc sql;
  create table ex_last as
  select USUBJID,
         max(EXENDTC) as TRTEDT format=date9.
  from sdtm.ex
  where EXDOSE > 0
  group by USUBJID;
quit;

步骤 4：派生年龄分组
────────────────────────────────────────
data adsl_step4;
  set adsl_step3;

  /* 年龄分组 */
  if AGE < 50 then do;
    AGEGR1 = '<50';
    AGEGR1N = 1;
  end;
  else if AGE < 65 then do;
    AGEGR1 = '50-64';
    AGEGR1N = 2;
  end;
  else do;
    AGEGR1 = '>=65';
    AGEGR1N = 3;
  end;
run;

步骤 5：派生分析集标志
────────────────────────────────────────
data adsl_step5;
  set adsl_step4;

  /* ITT 集：所有随机化 */
  if RANDFL = 'Y' then ITTFL = 'Y';
  else ITTFL = 'N';

  /* 安全性集：至少用药一次 */
  if TRTSDT ^= . then SAFFL = 'Y';
  else SAFFL = 'N';

  /* 符合方案集 */
  if ITTFL = 'Y' and COMPLFL = 'Y' and PRMAJVFL = 'N'
  then PPROTFL = 'Y';
  else PPROTFL = 'N';
run;
```

### BDS 数据集创建详细步骤

```
ADVS 创建详细步骤
───────────────────────────────────

步骤 1：从 VS 获取源数据
────────────────────────────────────────
data advs_step1;
  set sdtm.vs;
  where VSTESTCD in ('SYSBP', 'DIABP', 'HR');

  /* 转换变量名 */
  PARAMCD = VSTESTCD;
  PARAM = catx(' ', VSTEST, cats('(', VSORRESU, ')'));
  AVAL = VSSTRESN;
  ADT = input(VSDTC, yymmdd10.);

  keep STUDYID USUBJID PARAMCD PARAM AVAL ADT VISIT VISITNUM;
run;

步骤 2：合并 ADSL 信息
────────────────────────────────────────
proc sql;
  create table advs_step2 as
  select a.*,
         b.TRT01P, b.TRT01PN, b.TRT01A, b.TRT01AN,
         b.TRTSDT, b.TRTEDT,
         b.SAFFL, b.ITTFL,
         b.AGE, b.AGEGR1, b.SEX
  from advs_step1 a
  left join adam.adsl b
  on a.USUBJID = b.USUBJID;
quit;

步骤 3：计算研究日
────────────────────────────────────────
data advs_step3;
  set advs_step2;

  if ADT >= TRTSDT > . then ADY = ADT - TRTSDT + 1;
  else if ADT < TRTSDT then ADY = ADT - TRTSDT;
run;

步骤 4：确定基线
────────────────────────────────────────
/* 找到每个受试者每个参数治疗前最后一次 */
proc sort data=advs_step3;
  by USUBJID PARAMCD ADT;
run;

data advs_step4;
  set advs_step3;
  by USUBJID PARAMCD;

  /* 标记治疗前记录 */
  if ADT < TRTSDT or (ADT = TRTSDT and VISIT = 'BASELINE');

  /* 保留最后一条 */
  if last.PARAMCD;

  ABLFL = 'Y';
  keep USUBJID PARAMCD AVAL ABLFL;
  rename AVAL = BASE;
run;

/* 合并基线 */
proc sql;
  create table advs_step5 as
  select a.*,
         b.BASE,
         case when a.ADT = b.ADT then 'Y' else '' end as ABLFL
  from advs_step3 a
  left join advs_step4 b
  on a.USUBJID = b.USUBJID
     and a.PARAMCD = b.PARAMCD;
quit;

步骤 5：计算变化值
────────────────────────────────────────
data advs_step6;
  set advs_step5;

  /* 只有非基线行才计算变化 */
  if ABLFL ^= 'Y' and BASE ^= . and AVAL ^= . then do;
    CHG = AVAL - BASE;
    if BASE ^= 0 then PCHG = (CHG / BASE) * 100;
  end;
run;

步骤 6：设置分析标志
────────────────────────────────────────
data advs_step7;
  set advs_step6;

  /* 主要分析：基线 + Week 4 */
  if AVISIT in ('Baseline', 'Week 4') and AVAL ^= .
  then ANL01FL = 'Y';

  /* 辅助分析：所有计划访视 */
  if AVISIT in ('Baseline', 'Week 1', 'Week 2', 'Week 4')
     and AVAL ^= .
  then ANL02FL = 'Y';
run;

步骤 7：设置分析访视
────────────────────────────────────────
data adam.advs;
  set advs_step7;

  /* 分析访视 */
  if VISIT = 'SCREENING' then do;
    AVISIT = 'Screening';
    AVISITN = -1;
  end;
  else if VISIT = 'BASELINE' then do;
    AVISIT = 'Baseline';
    AVISITN = 0;
  end;
  else if VISIT = 'WEEK 1' then do;
    AVISIT = 'Week 1';
    AVISITN = 1;
  end;
  /* ... 其他访视 */
run;
```

---

## 12. 真实案例：从 SDTM 到 ADVS 的完整派生

### 案例背景

```
案例：降压药临床试验 ADVS 数据集创建
────────────────────────────────────

试验设计：
• 随机、双盲、安慰剂对照
• 治疗周期：4 周
• 主要终点：第 4 周收缩压变化值

分析要求（来自 SAP）：
• 基线定义：首次给药前最后一次非缺失测量
• 主要分析：FAS 人群，基线和 Week 4
• 主要指标：收缩压（SYSBP）、舒张压（DIABP）
```

### 步骤 1：源数据准备

```
SDTM VS 域源数据（部分）
────────────────────────────────────────────────────────────────────────

STUDYID   USUBJID        VSTESTCD  VSSTRESN  VSORRESU  VSDTC        VISIT
──────────────────────────────────────────────────────────────────────────
STUDY01   STUDY01-001    SYSBP     155       mmHg      2024-01-08   SCREENING
STUDY01   STUDY01-001    SYSBP     152       mmHg      2024-01-14   BASELINE
STUDY01   STUDY01-001    SYSBP     150       mmHg      2024-01-15   DAY 1
STUDY01   STUDY01-001    SYSBP     148       mmHg      2024-01-22   WEEK 1
STUDY01   STUDY01-001    SYSBP     142       mmHg      2024-01-29   WEEK 2
STUDY01   STUDY01-001    SYSBP     138       mmHg      2024-02-12   WEEK 4
STUDY01   STUDY01-001    DIABP     98        mmHg      2024-01-08   SCREENING
STUDY01   STUDY01-001    DIABP     95        mmHg      2024-01-14   BASELINE
...

ADSL 数据（部分）
────────────────────────────────────────────────────────────────────────

USUBJID        AGE  SEX  TRT01P   TRTSDT       SAFFL  ITTFL
──────────────────────────────────────────────────────────────────────────
STUDY01-001    58   M    Drug A   2024-01-15   Y      Y
STUDY01-002    62   F    Placebo  2024-01-16   Y      Y
STUDY01-003    45   M    Drug A   2024-01-17   Y      Y
```

### 步骤 2：变量映射和转换

```
变量映射表
────────────────────────────────────────────────────────────────────────

ADaM 变量      来源/派生方法                  说明
────────────────────────────────────────────────────────────────────────
STUDYID       VS.STUDYID                     直接复制
USUBJID       VS.USUBJID                     直接复制
PARAMCD       VS.VSTESTCD                    直接复制
PARAM         VS.VSTEST || ' (' ||           组合：检查名+单位
              VS.VSORRESU || ')'
AVAL          VS.VSSTRESN                    直接复制（标准化数值）
ADT           input(VS.VSDTC, yymmdd10.)     日期转换
VISIT         VS.VISIT                       直接复制
TRT01P        ADSL.TRT01P                    从 ADSL 合并
TRTSDT        ADSL.TRTSDT                    从 ADSL 合并
SAFFL         ADSL.SAFFL                     从 ADSL 合并
ITTFL         ADSL.ITTFL                     从 ADSL 合并
ADY           ADT - TRTSDT + 1               派生（给药后）
              ADT - TRTSDT                   派生（给药前）
BASE          ABLFL='Y'时的 AVAL             派生
ABLFL         'Y' if 治疗前最后一次          派生
CHG           AVAL - BASE                    派生
PCHG          (CHG/BASE)*100                 派生
ANL01FL       'Y' if 基线或 Week 4           派生
```

### 步骤 3：完整派生结果

```
ADVS 最终数据（STUDY01-001 的 SYSBP 记录）
────────────────────────────────────────────────────────────────────────

USUBJID      PARAMCD  PARAM                  AVISIT     ADT          ADY
────────────────────────────────────────────────────────────────────────
STUDY01-001  SYSBP    Systolic BP (mmHg)     Screening  2024-01-08   -7
STUDY01-001  SYSBP    Systolic BP (mmHg)     Baseline   2024-01-14   -1
STUDY01-001  SYSBP    Systolic BP (mmHg)     Day 1      2024-01-15   1
STUDY01-001  SYSBP    Systolic BP (mmHg)     Week 1     2024-01-22   8
STUDY01-001  SYSBP    Systolic BP (mmHg)     Week 2     2024-01-29   15
STUDY01-001  SYSBP    Systolic BP (mmHg)     Week 4     2024-02-12   29

────────────────────────────────────────────────────────────────────────
（续）
AVAL   BASE   CHG    PCHG    ABLFL  ANL01FL  TRT01P   SAFFL  ITTFL
────────────────────────────────────────────────────────────────────────
155    152    .      .       .      .        Drug A   Y      Y      筛选期
152    152    0      0       Y      Y        Drug A   Y      Y      ← 基线
150    152    -2     -1.3    .      .        Drug A   Y      Y
148    152    -4     -2.6    .      .        Drug A   Y      Y
142    152    -10    -6.6    .      .        Drug A   Y      Y
138    152    -14    -9.2    .      Y        Drug A   Y      Y      ← 主分析

派生说明：
──────────────────────────────────────────────────────────────────────
• TRTSDT = 2024-01-15（首次给药日期，从 ADSL 获取）
• 基线 = 2024-01-14 的测量值 = 152（治疗前最后一次）
• ABLFL = 'Y' 标记在 2024-01-14 这行
• BASE = 152 传播到所有行
• CHG = AVAL - 152
• PCHG = CHG / 152 * 100
• ANL01FL = 'Y' 仅在 Baseline 和 Week 4
• 筛选期数据的 BASE 也是 152（向前追溯）
• 筛选期数据的 CHG 通常不计算或设为缺失（因为不用于分析）
```

### 步骤 4：验证检查

```
关键验证检查点
────────────────────────────────────────────────────────────────────────

✅ 检查 1：每个受试者每个参数只有一个 ABLFL = 'Y'
   proc sql;
     select USUBJID, PARAMCD, count(*) as N
     from advs
     where ABLFL = 'Y'
     group by USUBJID, PARAMCD
     having N > 1;
   quit;
   /* 应该返回 0 行 */

✅ 检查 2：BASE 值正确传播
   proc sql;
     select USUBJID, PARAMCD, BASE, count(distinct BASE) as N
     from advs
     group by USUBJID, PARAMCD
     having N > 1;
   quit;
   /* 应该返回 0 行（每个受试者每个参数的 BASE 应该相同）*/

✅ 检查 3：CHG 计算正确
   proc sql;
     select *
     from advs
     where ABLFL ^= 'Y'
       and CHG ^= AVAL - BASE
       and CHG is not null;
   quit;
   /* 应该返回 0 行 */

✅ 检查 4：PCHG 计算正确
   proc sql;
     select *
     from advs
     where abs(PCHG - (CHG/BASE)*100) > 0.01
       and PCHG is not null;
   quit;
   /* 应该返回 0 行（允许小数点误差）*/

✅ 检查 5：与 ADSL 的一致性
   proc sql;
     select a.USUBJID
     from advs a
     where a.TRT01P ^= (select TRT01P from adsl where USUBJID = a.USUBJID);
   quit;
   /* 应该返回 0 行 */
```

---

## 13. 常见错误与最佳实践

### 常见错误

```
❌ 错误 1：基线定义不一致
────────────────────────────────────────

问题：同一指标在不同记录中使用了不同的基线定义

错误示例：
USUBJID  PARAMCD  AVISIT    BASE
001      SYSBP    Baseline  152     ← 正确
001      SYSBP    Week 4    150     ← 错误！BASE 变了

正确做法：
• 每个受试者每个参数的 BASE 值应该完全相同
• 用 RETAIN 语句或 MERGE 确保 BASE 正确传播
```

```
❌ 错误 2：忘记处理缺失值
────────────────────────────────────────

问题：当 AVAL 或 BASE 缺失时仍然计算 CHG

错误示例：
AVAL = .
BASE = 152
CHG = . - 152 = .  /* 这个可能不是缺失，而是非法值 */

正确做法：
if AVAL ^= . and BASE ^= . and ABLFL ^= 'Y' then
  CHG = AVAL - BASE;
else
  CHG = .;
```

```
❌ 错误 3：ADSL 信息合并不完整
────────────────────────────────────────

问题：BDS 数据集中某些受试者缺少 ADSL 信息

错误示例：
USUBJID      TRT01P    SAFFL
001          Drug A    Y
002          .         .       ← 缺少 ADSL 信息！

原因：USUBJID 不匹配或 LEFT JOIN 问题

正确做法：
• 合并后检查是否有缺失
• 确保 USUBJID 完全匹配
• 使用 INNER JOIN 时注意数据丢失
```

```
❌ 错误 4：ADY 计算不正确
────────────────────────────────────────

问题：ADY 的计算没有考虑"无 Day 0"规则

错误示例：
TRTSDT = 2024-01-15
ADT = 2024-01-15
ADY = 2024-01-15 - 2024-01-15 = 0  ← 错误！

正确做法：
if ADT >= TRTSDT then ADY = ADT - TRTSDT + 1;
/* 所以 2024-01-15 的 ADY = 1，不是 0 */
```

```
❌ 错误 5：分析标志设置不当
────────────────────────────────────────

问题：ANL01FL 包含了缺失数据

错误示例：
AVISIT = 'Week 4'
AVAL = .         ← 值缺失
ANL01FL = 'Y'    ← 错误！缺失值不应纳入分析

正确做法：
if AVISIT = 'Week 4' and AVAL ^= . then ANL01FL = 'Y';
```

### 最佳实践

```
✅ 最佳实践 1：先创建 ADSL
────────────────────────────────────────

ADSL 是所有其他 ADaM 数据集的基础。
必须先完成 ADSL，才能创建其他数据集。

流程：
1. 创建 ADSL
2. 验证 ADSL
3. 创建其他数据集并从 ADSL 合并信息
```

```
✅ 最佳实践 2：使用标准化的变量名
────────────────────────────────────────

ADaM 变量名有标准命名规则，遵守这些规则：

• PARAM, PARAMCD - 参数描述和代码
• AVAL, AVALC - 分析值
• BASE - 基线值
• CHG, PCHG - 变化值
• xxFL - 标志变量
• xxDT - 日期变量
• xxN - 数字版本
```

```
✅ 最佳实践 3：保持可追溯性
────────────────────────────────────────

每个 ADaM 变量都应该能追溯到：
• SDTM 源变量，或
• 明确的派生规则

在 Define.xml 中记录所有派生逻辑。

示例：
变量：CHG
来源：派生
方法：CHG = AVAL - BASE, where ABLFL ^= 'Y'
```

```
✅ 最佳实践 4：充分的 QC
────────────────────────────────────────

QC 检查清单：
□ 所有必须变量都存在
□ 变量类型和长度正确
□ 无重复记录（必要时）
□ 与 ADSL 的一致性
□ 派生计算正确
□ 缺失值处理正确
□ 日期逻辑正确（治疗前后判断）
□ 分析标志设置正确
```

```
✅ 最佳实践 5：文档化
────────────────────────────────────────

必须文档：
• ADRG（Analysis Data Reviewer's Guide）
  - 数据集列表
  - 特殊派生逻辑说明
  - 与 SAP 的对应关系

• Define.xml
  - 所有变量的定义
  - 派生方法
  - 受控术语

• 程序注释
  - 关键派生逻辑
  - 业务规则说明
```

---

## 14. ADaM 合规性检查清单

### ADSL 检查清单

```
ADSL 合规性检查
────────────────────────────────────────────────────────────────────────

□ 必须变量存在
  ├── □ STUDYID
  ├── □ USUBJID
  ├── □ SUBJID
  └── □ SITEID

□ 每个受试者只有一行
  └── 验证：proc sql; select USUBJID, count(*) from adsl
            group by USUBJID having count(*) > 1; quit;

□ 人口学变量完整
  ├── □ AGE, AGEU
  ├── □ SEX
  └── □ RACE, ETHNIC（如适用）

□ 治疗变量正确
  ├── □ TRT01P, TRT01PN（计划治疗）
  ├── □ TRT01A, TRT01AN（实际治疗）
  ├── □ TRTSDT（治疗开始日期）
  └── □ TRTEDT（治疗结束日期）

□ 分析集标志正确
  ├── □ ITTFL（ITT 集）
  ├── □ SAFFL（安全性集）
  └── □ 其他预定义的分析集

□ 变量属性正确
  ├── □ 字符变量长度充足
  ├── □ 数值变量精度正确
  └── □ 日期变量格式正确
```

### BDS 检查清单

```
BDS 数据集合规性检查（如 ADVS、ADLB）
────────────────────────────────────────────────────────────────────────

□ 必须变量存在
  ├── □ STUDYID, USUBJID
  ├── □ PARAM, PARAMCD
  └── □ AVAL（或 AVALC，至少有一个）

□ PARAM/PARAMCD 一致性
  └── 验证：每个 PARAMCD 只对应一个 PARAM

□ 基线相关
  ├── □ ABLFL 存在且每个 PARAMCD 只有一个 'Y'
  ├── □ BASE 值正确传播
  └── □ CHG/PCHG 计算正确

□ 与 ADSL 一致
  ├── □ 所有 USUBJID 都在 ADSL 中存在
  └── □ TRT01P 等变量与 ADSL 一致

□ 时间变量
  ├── □ ADT 或 ADTM 存在
  ├── □ ADY 计算正确
  └── □ AVISIT/AVISITN 设置正确

□ 分析标志
  ├── □ ANL01FL 等标志设置正确
  └── □ 缺失值不应有 ANL01FL = 'Y'
```

### OCCDS 检查清单

```
OCCDS 数据集合规性检查（如 ADAE）
────────────────────────────────────────────────────────────────────────

□ 必须变量存在
  ├── □ STUDYID, USUBJID
  └── □ 事件特定变量（如 AETERM, AEDECOD）

□ 与 ADSL 一致
  └── □ 所有 USUBJID 都在 ADSL 中

□ 日期逻辑正确
  ├── □ ASTDT（开始日期）格式正确
  ├── □ AENDT（结束日期）>= ASTDT
  └── □ TRTEMFL（治疗期标志）逻辑正确

□ 编码一致
  ├── □ AEDECOD 使用标准术语（MedDRA）
  └── □ AEBODSYS 与 AEDECOD 匹配
```

---

## 15. 总结与速查表

### ADaM 核心概念速查

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ADaM 核心概念速查表                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  数据集类型                                                              │
│  ──────────────────────────────────────────────────────────            │
│  ADSL    受试者级别    一人一行    人口学、分析集标志                      │
│  BDS     基本数据结构   多行/人     连续指标（血压、实验室）                │
│  OCCDS   事件类数据    多行/人     不良事件、合并用药                      │
│                                                                         │
│  核心变量                                                                │
│  ──────────────────────────────────────────────────────────            │
│  AVAL    分析值        数值        检查/测量结果                          │
│  BASE    基线值        数值        治疗前的 AVAL                          │
│  CHG     变化值        数值        AVAL - BASE                           │
│  PCHG    变化百分比    数值        (CHG/BASE) × 100                      │
│  ABLFL   基线标志      Y/空        标记哪行是基线                          │
│  ANL01FL 分析标志      Y/空        标记纳入分析的记录                      │
│                                                                         │
│  关键原则                                                                │
│  ──────────────────────────────────────────────────────────            │
│  1. 分析就绪：数据可直接用于统计分析                                       │
│  2. 可追溯：每个变量可追溯到源数据或派生规则                               │
│  3. ADSL 优先：必须先创建 ADSL，其他数据集从 ADSL 合并信息                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 派生公式速查

```
常用派生公式
────────────────────────────────────────────────────────────────────────

派生变量          公式/规则                           说明
────────────────────────────────────────────────────────────────────────
CHG              AVAL - BASE                         绝对变化
PCHG             (CHG / BASE) × 100                  百分比变化
ADY (治疗后)      ADT - TRTSDT + 1                    研究日（Day 1 起）
ADY (治疗前)      ADT - TRTSDT                        研究日（负数）
TRTDURD          TRTEDT - TRTSDT + 1                 治疗持续天数
AGEGR1           if AGE<50: "<50"                    年龄分组
                 if 50<=AGE<65: "50-64"
                 else: ">=65"
TRTEMFL          'Y' if ASTDT >= TRTSDT              治疗期 AE 标志
```

### 变量来源速查

```
BDS 变量来源速查
────────────────────────────────────────────────────────────────────────

变量              来源                                类型
────────────────────────────────────────────────────────────────────────
STUDYID          SDTM 直接复制                       标识符
USUBJID          SDTM 直接复制                       标识符
PARAM            SDTM 转换（加单位）                  参数
PARAMCD          SDTM 直接复制                       参数代码
AVAL             SDTM 转换（--STRESN）               分析值
ADT              SDTM 日期转换（--DTC）              日期
TRT01P           从 ADSL 合并                        治疗
SAFFL            从 ADSL 合并                        标志
BASE             派生（基线的 AVAL）                  基线
ABLFL            派生（标记基线行）                   标志
CHG              派生（AVAL - BASE）                 变化
PCHG             派生（CHG/BASE×100）                变化百分比
ANL01FL          派生（按 SAP 规则）                  分析标志
```

### 完整流程图

```
ADaM 创建完整流程
────────────────────────────────────────────────────────────────────────

     ┌───────────┐
     │   SAP     │  统计分析计划：定义分析方法、终点、人群
     └─────┬─────┘
           │
           ▼
     ┌───────────┐
     │   SDTM    │  源数据：DM、VS、LB、AE、EX 等
     └─────┬─────┘
           │
           │  ┌────────────────────────────────────────────┐
           │  │  步骤 1：创建 ADSL                          │
           │  │  • 从 DM 获取人口学                         │
           │  │  • 从 EX 计算治疗日期                       │
           │  │  • 派生分析集标志                           │
           │  │  • 派生分类变量                             │
           │  └────────────────────────────────────────────┘
           │
           ▼
     ╔═══════════╗
     ║   ADSL    ║  核心数据集（一人一行）
     ╚═════╤═════╝
           │
           ├─────────────────────────────────────────────────┐
           │                                                 │
           │  ┌────────────────────────────────────────────┐ │
           │  │  步骤 2：创建 BDS 数据集                     │ │
           │  │  • 从对应 SDTM 获取源数据                    │ │
           │  │  • 合并 ADSL 信息                           │ │
           │  │  • 派生 AVAL、BASE、CHG、PCHG              │ │
           │  │  • 设置 ABLFL、ANL01FL                     │ │
           │  └────────────────────────────────────────────┘ │
           │                                                 │
           ▼                                                 ▼
     ┌───────────┐                                   ┌───────────┐
     │   ADVS    │  生命体征                          │   ADAE    │  不良事件
     │   ADLB    │  实验室                            │   ADCM    │  合并用药
     │   ADEFF   │  疗效                              │   ADMH    │  病史
     └─────┬─────┘                                   └─────┬─────┘
           │                                                 │
           └───────────────────┬─────────────────────────────┘
                               │
                               ▼
                        ┌───────────┐
                        │   QC      │  质量检查
                        │ 验证派生   │  合规检查
                        └─────┬─────┘
                               │
                               ▼
                        ┌───────────┐
                        │ Define.xml│  元数据文档
                        │   ADRG    │  审评员指南
                        └───────────┘
```

---

## 附录：ADaM 术语表

| 术语 | 英文全称 | 中文含义 |
|------|----------|----------|
| ADaM | Analysis Data Model | 分析数据模型 |
| ADSL | Subject-Level Analysis Dataset | 受试者级别分析数据集 |
| BDS | Basic Data Structure | 基本数据结构 |
| OCCDS | Occurrence Data Structure | 事件类数据结构 |
| PARAM | Parameter | 参数（完整描述） |
| PARAMCD | Parameter Code | 参数代码 |
| AVAL | Analysis Value | 分析值 |
| BASE | Baseline Value | 基线值 |
| CHG | Change from Baseline | 基线变化值 |
| PCHG | Percent Change from Baseline | 基线变化百分比 |
| ABLFL | Baseline Record Flag | 基线记录标志 |
| ANL01FL | Analysis Flag 01 | 分析标志 01 |
| ADT | Analysis Date | 分析日期 |
| ADY | Analysis Relative Day | 分析相对日 |
| AVISIT | Analysis Visit | 分析访视 |
| TRTSDT | Treatment Start Date | 治疗开始日期 |
| TRTEDT | Treatment End Date | 治疗结束日期 |
| ITTFL | Intent-to-Treat Flag | 意向治疗标志 |
| SAFFL | Safety Population Flag | 安全性人群标志 |

---

## 相关阅读

- [SDTM/ADaM 入门教程](./SDTM_ADaM_Tutorial.md) - 了解整体流程
- [SDTM 域详解](./SDTM_Domain_Guide.md) - 了解源数据结构
- [SAP 统计分析计划](./SAP_Tutorial.md) - 了解分析需求
- [提交包指南](./Submission_Package_Guide.md) - 了解最终交付

---

*本文档由 AI 辅助生成，如有疑问请咨询专业人士。*
